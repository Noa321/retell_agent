<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Assistant - Web Chat</title>
    
    <!-- Try multiple CDN sources for Retell SDK -->
    <script src="https://unpkg.com/retell-sdk@latest/dist/retell-sdk.umd.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .voice-controls {
            text-align: center;
            margin: 40px 0;
        }
        
        .voice-button {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
            margin: 0 10px;
        }
        
        .voice-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(39, 174, 96, 0.6);
        }
        
        .voice-button:disabled {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.4);
        }
        
        .voice-button.active {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            animation: pulse 2s infinite;
        }
        
        .voice-button.connecting {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .status-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 30px 0;
            text-align: center;
            font-size: 18px;
            font-weight: 500;
        }
        
        .transcript-box {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            overflow-y: auto;
            max-height: 400px;
        }
        
        .transcript-box h3 {
            margin-top: 0;
            color: #ffd700;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .transcript-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .transcript-user {
            background: rgba(52, 152, 219, 0.3);
            margin-left: 20px;
        }
        
        .transcript-assistant {
            background: rgba(39, 174, 96, 0.3);
            margin-right: 20px;
        }
        
        .debug-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #bdc3c7;
        }
        
        .success {
            color: #2ecc71;
        }
        
        .error {
            color: #e74c3c;
        }
        
        .info {
            color: #3498db;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }
        
        .instructions h3 {
            color: #ffd700;
            margin-top: 0;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ AI Voice Assistant</h1>
        
        <div class="voice-controls">
            <button id="startButton" class="voice-button" onclick="startVoiceChat()">
                üéôÔ∏è Start Voice Chat
            </button>
            <button id="endButton" class="voice-button" onclick="endVoiceChat()" style="display: none;">
                üî¥ End Chat
            </button>
        </div>
        
        <div class="status-display" id="status">
            üîÑ Initializing voice assistant...
        </div>
        
        <div class="transcript-box" id="transcriptBox">
            <h3>üí¨ Conversation</h3>
            <div id="transcript">
                <p style="color: #bdc3c7; font-style: italic;">Conversation will appear here once you start talking...</p>
            </div>
        </div>
        
        <div class="instructions">
            <h3>üìã How to Use</h3>
            <ul>
                <li><strong>Click "Start Voice Chat"</strong> to begin</li>
                <li><strong>Allow microphone access</strong> when your browser asks</li>
                <li><strong>Start speaking</strong> - the AI will respond in real-time</li>
                <li><strong>Wait for responses</strong> - the AI needs a moment to think and speak</li>
                <li><strong>Click "End Chat"</strong> when you're finished</li>
            </ul>
            <p><strong>üí° Tip:</strong> Make sure you're in a quiet environment for best results!</p>
        </div>
        
        <div class="debug-info" id="debugInfo">
            <strong>üîß Debug Information:</strong><br>
            <div id="debugLog">Checking system status...</div>
        </div>
    </div>

    <script>
        class WebVoiceAssistant {
            constructor() {
                this.retellClient = null;
                this.isCallActive = false;
                this.isConnecting = false;
                
                this.statusEl = document.getElementById('status');
                this.transcriptEl = document.getElementById('transcript');
                this.startBtn = document.getElementById('startButton');
                this.endBtn = document.getElementById('endButton');
                this.debugLog = document.getElementById('debugLog');
                
                this.initializeSDK();
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const className = type; // 'success', 'error', 'info'
                
                console.log(`[${timestamp}] ${message}`);
                
                this.debugLog.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
                this.debugLog.scrollTop = this.debugLog.scrollHeight;
            }
            
            async initializeSDK() {
                this.log('üîÑ Checking for Retell SDK...', 'info');
                
                // Give the script tag time to load
                let attempts = 0;
                const maxAttempts = 10;
                
                const checkSDK = () => {
                    attempts++;
                    
                    if (window.RetellWebClient) {
                        this.log('‚úÖ Retell SDK loaded successfully!', 'success');
                        this.setupRetellClient();
                        this.updateStatus('‚úÖ Voice assistant ready! Click "Start Voice Chat" to begin.');
                        this.startBtn.disabled = false;
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        this.log('‚ùå Failed to load Retell SDK after multiple attempts', 'error');
                        this.updateStatus('‚ùå Voice assistant unavailable. SDK failed to load.');
                        this.tryAlternativeLoading();
                        return;
                    }
                    
                    this.log(`‚è≥ Waiting for SDK... (attempt ${attempts}/${maxAttempts})`, 'info');
                    setTimeout(checkSDK, 500);
                };
                
                checkSDK();
            }
            
            async tryAlternativeLoading() {
                this.log('üîÑ Trying alternative SDK loading method...', 'info');
                
                try {
                    // Try loading from different CDNs
                    const cdnUrls = [
                        'https://cdn.skypack.dev/retell-sdk',
                        'https://esm.sh/retell-sdk',
                        'https://cdn.jsdelivr.net/npm/retell-sdk@latest/dist/retell-sdk.umd.js'
                    ];
                    
                    for (const url of cdnUrls) {
                        try {
                            this.log(`üîÑ Trying CDN: ${url}`, 'info');
                            await this.loadScript(url);
                            
                            if (window.RetellWebClient) {
                                this.log('‚úÖ Alternative loading successful!', 'success');
                                this.setupRetellClient();
                                this.updateStatus('‚úÖ Voice assistant ready! Click "Start Voice Chat" to begin.');
                                this.startBtn.disabled = false;
                                return;
                            }
                        } catch (error) {
                            this.log(`‚ùå CDN failed: ${url}`, 'error');
                        }
                    }
                    
                    throw new Error('All CDN attempts failed');
                    
                } catch (error) {
                    this.log('‚ùå All loading attempts failed. Your backend is working, but web SDK is unavailable.', 'error');
                    this.updateStatus('‚ùå Web voice chat unavailable. SDK loading failed.');
                    this.showBackendWorking();
                }
            }
            
            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            
            setupRetellClient() {
                try {
                    this.retellClient = new window.RetellWebClient();
                    
                    this.retellClient.on("call_started", () => {
                        this.log('üìû Voice call started successfully!', 'success');
                        this.isCallActive = true;
                        this.isConnecting = false;
                        this.updateStatus('üéôÔ∏è Voice chat active! Start speaking...');
                        this.updateButtons();
                    });

                    this.retellClient.on("call_ended", () => {
                        this.log('üìû Voice call ended', 'info');
                        this.isCallActive = false;
                        this.isConnecting = false;
                        this.updateStatus('üìû Voice chat ended. Click "Start Voice Chat" to begin again.');
                        this.updateButtons();
                    });

                    this.retellClient.on("agent_start_talking", () => {
                        this.log('üó£Ô∏è AI is speaking...', 'info');
                        this.updateStatus('üó£Ô∏è AI is speaking... (wait for response to finish)');
                    });

                    this.retellClient.on("agent_stop_talking", () => {
                        this.log('üëÇ AI finished speaking, listening for your response...', 'info');
                        this.updateStatus('üëÇ Listening for your voice...');
                    });

                    this.retellClient.on("update", (update) => {
                        if (update.transcript && update.transcript.length > 0) {
                            this.updateTranscript(update.transcript);
                        }
                    });

                    this.retellClient.on("error", (error) => {
                        this.log(`‚ùå Voice call error: ${error.message}`, 'error');
                        this.updateStatus('‚ùå Voice call error. Please try again.');
                        this.isCallActive = false;
                        this.isConnecting = false;
                        this.updateButtons();
                    });
                    
                    this.log('‚úÖ Retell client initialized successfully', 'success');
                    
                } catch (error) {
                    this.log(`‚ùå Failed to initialize Retell client: ${error.message}`, 'error');
                    this.updateStatus('‚ùå Failed to initialize voice client');
                }
            }
            
            async startVoiceChat() {
                if (!this.retellClient) {
                    alert('Voice assistant not ready. Please refresh the page and try again.');
                    return;
                }
                
                if (this.isCallActive) {
                    this.endVoiceChat();
                    return;
                }
                
                try {
                    this.isConnecting = true;
                    this.log('üîÑ Starting voice chat...', 'info');
                    this.updateStatus('üîÑ Connecting to voice assistant...');
                    this.updateButtons();
                    
                    // Test backend first
                    this.log('üîÑ Testing backend connection...', 'info');
                    
                    const response = await fetch('/api/create-web-call', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: this.generateUserId(),
                            metadata: {
                                page_url: window.location.href,
                                user_agent: navigator.userAgent,
                                timestamp: new Date().toISOString()
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Backend error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    this.log(`‚úÖ Backend responded! Access token: ${data.access_token.substring(0, 20)}...`, 'success');

                    // Start the voice call
                    this.log('üîÑ Starting Retell voice call...', 'info');
                    await this.retellClient.startCall({
                        accessToken: data.access_token,
                        sampleRate: 24000,
                        enableUpdate: true
                    });
                    
                    this.log('‚úÖ Voice call request sent successfully!', 'success');

                } catch (error) {
                    this.log(`‚ùå Failed to start voice chat: ${error.message}`, 'error');
                    this.updateStatus(`‚ùå Failed to start voice chat: ${error.message}`);
                    this.isConnecting = false;
                    this.updateButtons();
                    
                    // Show specific help for common issues
                    if (error.message.includes('Backend error')) {
                        this.updateStatus('‚ùå Backend connection failed. Please check your API is working.');
                    } else if (error.message.includes('permission')) {
                        this.updateStatus('‚ùå Microphone permission denied. Please allow microphone access and try again.');
                    }
                }
            }
            
            endVoiceChat() {
                if (this.retellClient && this.isCallActive) {
                    this.log('üîÑ Ending voice chat...', 'info');
                    this.retellClient.stopCall();
                }
            }
            
            updateStatus(message) {
                this.statusEl.textContent = message;
            }
            
            updateButtons() {
                if (this.isConnecting) {
                    this.startBtn.textContent = '‚è≥ Connecting...';
                    this.startBtn.className = 'voice-button connecting';
                    this.startBtn.disabled = true;
                    this.endBtn.style.display = 'none';
                } else if (this.isCallActive) {
                    this.startBtn.style.display = 'none';
                    this.endBtn.style.display = 'inline-block';
                    this.endBtn.className = 'voice-button active';
                } else {
                    this.startBtn.textContent = 'üéôÔ∏è Start Voice Chat';
                    this.startBtn.className = 'voice-button';
                    this.startBtn.disabled = !this.retellClient;
                    this.startBtn.style.display = 'inline-block';
                    this.endBtn.style.display = 'none';
                }
            }
            
            updateTranscript(transcript) {
                let html = '';
                transcript.forEach(item => {
                    const className = item.role === 'user' ? 'transcript-user' : 'transcript-assistant';
                    const speaker = item.role === 'user' ? 'üë§ You' : 'ü§ñ AI Assistant';
                    html += `<div class="transcript-message ${className}">
                        <strong>${speaker}:</strong> ${item.content}
                    </div>`;
                });
                
                this.transcriptEl.innerHTML = html;
                this.transcriptEl.scrollTop = this.transcriptEl.scrollHeight;
            }
            
            showBackendWorking() {
                this.updateStatus('‚úÖ Backend is working perfectly! Web SDK unavailable - try refreshing or use a different browser.');
                
                // Test the backend to show it's working
                fetch('/api/create-web-call', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'test_' + Date.now(),
                        metadata: { test: true }
                    })
                }).then(response => response.json())
                  .then(data => {
                      this.log(`‚úÖ Backend test successful! Token: ${data.access_token?.substring(0, 20)}...`, 'success');
                  })
                  .catch(error => {
                      this.log(`‚ùå Backend test failed: ${error.message}`, 'error');
                  });
            }
            
            generateUserId() {
                return 'user_' + Math.random().toString(36).substr(2, 9);
            }
        }
        
        // Global functions
        let voiceAssistant;
        
        function startVoiceChat() {
            if (voiceAssistant) {
                voiceAssistant.startVoiceChat();
            }
        }
        
        function endVoiceChat() {
            if (voiceAssistant) {
                voiceAssistant.endVoiceChat();
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            voiceAssistant = new WebVoiceAssistant();
        });
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && voiceAssistant && voiceAssistant.isCallActive) {
                // Optionally end call when tab becomes hidden
                console.log('Tab hidden - call still active');
            }
        });
    </script>
</body>
</html>
